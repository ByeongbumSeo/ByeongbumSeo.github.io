---
title: HikariCP(작성중)
date: 2023-12-07 22:00:22 +09:00
categories:
  - 언어
  - Java
tags:
  - Java
  - HikariCP
  - Database
  - Connection Pool
  - JDBC
---

## 공부하게된 배경

나와 같이 Java, 특히 Springboot를 이용하여 개발하는 사람들에게 HikariCP는 매우 익숙하다.  
나는 개발을 시작하면서부터 자연스럽게 HikariCP를 이용하고 있었는데, 그동안 아무 생각없이 사용하던 이 라이브러리를 이번 기회에 정리하려고 한다.  

> Spring Boot 2.0 버전부터는 Tomcat JDBC 대신에 Hikari를 사용하며 spring-boot-starter-data-jpa 와 spring-boot-starter-jdbc에 의존성이 포함되어 있다고 한다.

## 다루는 내용
이 글에서는 HikariCP 를 설명하며 연관 지식으로
- DB Connection
- JDBC
- Connection Pool

에 대해서도 다룬다.  

HikariCP를 공부하면서 자연스럽게 위와 같은 내용을 다루게 되었다.


## HikariCP(Hikari Connection Pool) 란?

> Fast, simple, reliable. HikariCP is a "zero-overhead" production ready JDBC connection pool. At roughly 130Kb, the library is very light.

> 빠르고, 간단하고 믿을 수 있는 HikariCP는 "오버헤드 제로"의 프로덕션 지원 JDBC 연결 풀입니다. 대략 130KB이며 이 라이브러리는 매우 가볍습니다.

출처 : https://github.com/brettwooldridge/HikariCP#-hikaricpits-fasterhikari-hikal

- HikariCP는 **데이터베이스 연결(Connection)을 관리해 주는 도구(라이브러리)**이다.
- HikariCP에서 커넥션 풀(Connection Pool)이 설정된 커넥션의 사이즈만큼의 연결을 허용하며 HTTP 요청에 대해 순차적으로 DB 커넥션을 처리해 주는 기능을 수행한다.
- SpringBoot는 커넥션 풀 관리를 위해 HikariCP를 사용한다. 


## 데이터 베이스 커넥션 풀(DBCP : Database Connection Pool)

WAS(Web Application Server)와 데이터베이스 사이의 연결에는 많은 비용이 든다. MySQL 8.0을 기준으로 INSERT 문을 수행할 때 필요한 비용의 비율은 다음과 같다. 괄호 안의 숫자가 비율을 의미한다.
 
1. Connecting (3) 
2. Sending query to server (2)
3. Parsing query (2)
4. Inserting row (1)
5. Inserting index(1)
6. Closing (1)
 
즉, 서버가 DB에 연결하기 위한 Connecting 비용이 가장 큰 비율을 차지한다. 이처럼 Connection을 생성하는 작업은 비용이 많이 드는 작업이다. 이를 보완할 수 있는 방법이 바로 Connection Pool이다.


![커넥션 풀](/assets/img/posts/2023-12-11-23-40-04.png)
> 출처: https://www.ibm.com/developerworks/data/library/techarticle/dm-1105fivemethods/index.html 


커넥션 풀은 데이터베이스와 연결된 커넥션을 미리 만들어 놓고 이를 pool로 관리하는 것이다. 즉, 필요할 때마다 커넥션 풀의 커넥션을 이용하고 반환하는 기법이다. 이처럼 미리 만들어 놓은 커넥션을 이용하면 Connection에 필요한 비용을 줄일 수 있다. 따라서 DB에 빠르게 접속할 수 있다.
 
또한 커넥션 풀을 사용하면 커넥션 수를 제한할 수 있어서 과도한 접속으로 인한 서버 자원 고갈을 방지할 수 있으며 DB 접속 모듈을 공통화해 DB 서버의 환경이 바뀔 경우 유지보수를 쉽게 할 수 있다.

### Connection Pool 동작 과정

![커넥션풀 동작과정](/assets/img/posts/2023-12-11-23-50-20.png)
> Thread가 커넥션을 요청했을 때 유휴 커넥션이 존재한다면 해당 커넥션을 반환해준다.


![HandOffQueue](/assets/img/posts/2023-12-11-23-51-02.png)
> 만약 유휴 커넥션이 존재하지 않는다면, HandOffQueue를 Polling 하면서 다른 Thread가 커넥션을 반납하기를 기다린다.  
> 다른 Thread가 커넥션 풀에 커넥션을 반납하면 커넥션 풀은 HandOffQueue에 반납된 커넥션을 삽입하고 HandOffQueue를 Polling 하던 Thread는 커넥션을 획득하게 된다.



만약 커넥션 풀의 크기가 너무 작다면, 커넥션을 획득하기 위해 대기하고 있는 Thread가 많아지게 될 것이다. 이러한 문제는 커넥션 풀의 크기를 늘려주면 해결할 수 있다. 그렇다면 커넥션 풀의 크기는 어느 정도인 게 좋을까?

### JDBC(Java DataBase Connetion) 과정
![JDBC 과정](/assets/img/posts/2023-12-07-23-45-13.png)

JDBC 연결은 드라이버를 로드하고 연결하여 객체를 받아와야 하는 과정을 가지고 있습니다.  
이 과정은 매번 사용자가 요청할 때마다 드라이버를 로드하고 커넥션 객체를 생성하여 연결하고 종료하는 과정이 불편하고 속도와 자원 소모에 대한 단점이 있었습니다.

- 그래서 이 단점을 보완하기 위해 ‘데이터 베이스 커넥션 풀(DBCP)’을 사용합니다

### DBCP(Database Connection Pool) 이해 및 과정

#### 데이터베이스 커넥션 풀 (DBCP: Database Connection Pool)

- 데이터베이스 커넥션 풀은 최초 Pool 내에서 연결(Connection)들을 하여 HTTP 요청에 따라 응답을 제공하고 반환받아서 이를 **재사용하는 것**을 의미합니다.
![DBCP 과정](/assets/img/posts/2023-12-08-01-33-39.png)
> 출처: https://yjh5369.tistory.com/entry/HikariCP-%EC%86%8C%EA%B0%9C

#### 데이터베이스 커넥션 풀 (DBCP: Database Connection Pool)의 과정

1. WAS가 실행되면서 Pool 내에 Connection들을 생성해 둡니다.
2. HTTP의 요청이 올때 Pool 내에서 Connection 객체를 가져다가 사용합니다.
3. 사용이 완료된 Connection 객체는 Pool 내에 반환합니다.


#### DBCP의 장점

1. WAS와 데이터 베이스와의 연결(Connection)을 줄여서 비용을 줄입니다.

2. 'Pool'내에 미리 연결(Connection)되어 있기에 매번 생성하는 비용을 줄일 수 있습니다

3. 연결(Connection)에 대해서 조정을 할 수 있습니다. (단, 인프라의 DB Connection 수와 맞추어야 합니다.)

- Connection Pool을 크게 설정하면 메모리 소모가 큰 대신 많은 사람의 대기시간이 줄어듭니다.
- Coonection Pool을 적게 설정하면 사용자의 대기시간이 길어집니다.

오버헤드

[^1] : HiKariCP는 Hi·ka·ri [hi·ka·'lē] ( 원산지: 일본어 ): 빛;이라는 의미입니다. 
[^2] : 오버헤드(overhead)는 어떤 처리를 하기 위해 들어가는 간접적인 처리 시간 · 메모리 등을 의미합니다.


## HikariCP 설치

1. 빌드 관리 도구에 라이브러리 추가

기존 라이브러리 `spring-boot-data-jdbc` 내에 HikariCP가 포함이 되어 있다.

```gradle
dependencies {
	implementation 'org.springframework.boot:spring-boot-starter-data-jdbc'
}
```

2. application.properties 파일 수정
💡 기존에는 ‘datasource’ 내에 바로 연결을 하였으나 ‘hikari’를 중간에 거쳐서 환경설정을 하였습니다.

```properties
spring:
  datasource:
    hikari:
      driver-class-name: org.postgresql.Driver
      jdbc-url: jdbc:postgresql://localhost:8000/test_db
      username: test
      password: xxxxx
      pool-name: Hikari Connection Pool  # Pool Name Alias
      maximum-pool-size: 20
```






## : Reference
출처: https://code-lab1.tistory.com/209 [코드 연구소:티스토리]
